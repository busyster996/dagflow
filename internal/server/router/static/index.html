<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="dagflow - ç°ä»£åŒ–ä»»åŠ¡æµæ°´çº¿ç®¡ç†å¹³å°">
    <title>DagFlow - ä»»åŠ¡æµæ°´çº¿ç®¡ç†</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ”„</text></svg>">
</head>
<body>
<!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
<div id="loading-indicator" style="
        position: fixed;
        inset: 0;
        background: var(--gray-50);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        transition: opacity 0.3s ease;
    ">
    <div style="text-align: center;">
        <div class="loading" style="margin: 0 auto 16px;"></div>
        <p style="color: var(--gray-600); font-size: 14px;">æ­£åœ¨åŠ è½½åº”ç”¨...</p>
    </div>
</div>

<script type="text/javascript">
    function getBasePath() {
        const currentUrl = new URL(window.location.href);
        const pathSegments = currentUrl.pathname.split('/');
        if (pathSegments[pathSegments.length - 1].includes('.')) {
            pathSegments.pop();
        }
        let basePath = pathSegments.join('/');
        if (basePath.endsWith('/')) {
            basePath = basePath.slice(0, -1);
        }
        return basePath;
    }

    // åº”ç”¨é…ç½®
    const hostname = window.location.hostname;
    const protocol = window.location.protocol;
    const basePath = getBasePath();
    const port = window.location.port || (protocol === 'https:' ? '443' : '80');
    const wsProtocol = protocol === 'https:' ? 'wss' : 'ws';
    const baseUrl = protocol + '//' + hostname + ':' + port + basePath;
    const wsBaseUrl = wsProtocol + '://' + hostname + ':' + port + basePath;
    const eventUrl = '/api/v1/event';
    const taskUrl = '/api/v1/task';
    const pipelineUrl = '/api/v1/pipeline';

    // å…¨å±€å˜é‡å£°æ˜
    window.monaco = null;
    window.G6 = null;

    function loadCSS(filename) {
        return new Promise((resolve, reject) => {
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = filename;
            link.onload = resolve;
            link.onerror = () => reject(new Error(`CSS åŠ è½½å¤±è´¥: ${filename}`));
            document.head.appendChild(link);
        });
    }

    function loadJS(filename) {
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = filename;
            script.onload = resolve;
            script.onerror = () => reject(new Error(`JS åŠ è½½å¤±è´¥: ${filename}`));
            document.body.appendChild(script);
        });
    }

    // é…ç½®Monaco Editor
    function setupMonacoEditor() {
        return new Promise((resolve) => {
            // é…ç½®requireè·¯å¾„
            window.require = window.require || {};
            window.require.config = window.require.config || function() {};

            if (!window.require.config._configured) {
                window.require.config({
                    paths: { 'vs': baseUrl + '/vs' },
                });
                window.require.config._configured = true;
            }

            // ç¡®ä¿åªåŠ è½½ä¸€æ¬¡
            if (window.monaco) {
                resolve();
                return;
            }

            window.require(['vs/editor/editor.main'], function(monaco) {
                window.monaco = monaco;
                console.log('Monaco Editor åŠ è½½å®Œæˆ');
                resolve();
            });
        });
    }

    async function loadResources() {
        try {
            // 1. åŠ è½½ CSS
            await loadCSS(`${baseUrl}/css/main.css`);

            // 2. åŠ è½½ G6
            await loadJS(`${baseUrl}/js/g6.min.js`);
            console.log('G6 åŠ è½½å®Œæˆ');

            // 3. åŠ è½½ Monaco Editor loader
            await loadJS(`${baseUrl}/vs/loader.js`);

            // 4. é…ç½®å¹¶åŠ è½½ Monaco Editor
            await setupMonacoEditor();

            // 5. æœ€ååŠ è½½ä¸»åº”ç”¨
            await loadJS(`${baseUrl}/js/main.js`);

        } catch (error) {
            throw error;
        }
    }

    async function initApp() {
        try {
            await loadResources();
            console.log('æ‰€æœ‰èµ„æºåŠ è½½å®Œæˆ');

            // ç¡®ä¿G6å’ŒMonacoéƒ½å·²åŠ è½½
            if (!window.G6) {
                throw new Error('G6 æœªæ­£ç¡®åŠ è½½');
            }
            if (!window.monaco) {
                throw new Error('Monaco Editor æœªæ­£ç¡®åŠ è½½');
            }

            console.log('å¼€å§‹åˆå§‹åŒ–ä¸»åº”ç”¨...');
            new Main();
            console.log('dagflow åº”ç”¨å·²æˆåŠŸå¯åŠ¨');
        } catch (error) {
            console.error('åº”ç”¨å¯åŠ¨å¤±è´¥:', error);
            // æ˜¾ç¤ºé”™è¯¯ç•Œé¢
            document.body.innerHTML = `
                <div style="
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    height: 100vh;
                    background: var(--gray-50);
                    color: var(--danger-color);
                    text-align: center;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                ">
                    <div>
                        <h2>åº”ç”¨å¯åŠ¨å¤±è´¥</h2>
                        <p>è¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼Œæˆ–è”ç³»ç®¡ç†å‘˜</p>
                        <p style="font-size: 12px; color: var(--gray-500); margin-top: 8px;">
                            é”™è¯¯ä¿¡æ¯: ${error.message}
                        </p>
                        <button onclick="location.reload()" style="
                            margin-top: 16px;
                            padding: 8px 16px;
                            background: var(--primary-color);
                            color: white;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                        ">åˆ·æ–°é¡µé¢</button>
                    </div>
                </div>
            `;
        }
    }

    document.addEventListener("DOMContentLoaded", async () => {
        try {
            await initApp();
            // éšè—åŠ è½½æŒ‡ç¤ºå™¨
            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator) {
                setTimeout(() => {
                    loadingIndicator.style.opacity = '0';
                    setTimeout(() => {
                        loadingIndicator.remove();
                    }, 300);
                }, 500);
            }
        } catch (error) {
            console.error('åº”ç”¨å¯åŠ¨å¤±è´¥:', error);
        }
    });

    // å…¨å±€é”™è¯¯å¤„ç†
    window.addEventListener('error', (event) => {
        console.error('å…¨å±€é”™è¯¯:', event.error);
    });

    window.addEventListener('unhandledrejection', (event) => {
        console.error('æœªå¤„ç†çš„Promiseé”™è¯¯:', event.reason);
    });
</script>
</body>
</html>

