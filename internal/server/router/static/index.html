<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="dagflow - ç°ä»£åŒ–ä»»åŠ¡æµæ°´çº¿ç®¡ç†å¹³å°">
    <title>DagFlow - ä»»åŠ¡æµæ°´çº¿ç®¡ç†</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ”„</text></svg>">
    
    <style>
        /* åŠ è½½æŒ‡ç¤ºå™¨æ ·å¼ */
        #loading-indicator {
            position: fixed;
            inset: 0;
            background: var(--gray-50, #f9fafb);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }

        .loading-content {
            text-align: center;
            max-width: 300px;
        }

        .loading-spinner {
            margin: 0 auto 16px;
        }

        .loading-text {
            color: var(--gray-600, #6b7280);
            font-size: 14px;
            margin: 8px 0;
        }

        .loading-progress {
            margin-top: 12px;
            font-size: 12px;
            color: var(--gray-500, #9ca3af);
        }

        /* é”™è¯¯ç•Œé¢æ ·å¼ */
        .error-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: var(--gray-50, #f9fafb);
            text-align: center;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            padding: 20px;
        }

        .error-content {
            max-width: 500px;
        }

        .error-title {
            color: var(--danger-color, #dc2626);
            margin-bottom: 16px;
        }

        .error-message {
            color: var(--gray-700, #374151);
            margin-bottom: 12px;
        }

        .error-details {
            font-size: 12px;
            color: var(--gray-500, #9ca3af);
            margin-top: 8px;
            padding: 12px;
            background: var(--gray-100, #f3f4f6);
            border-radius: 6px;
            word-break: break-word;
        }

        .error-actions {
            margin-top: 24px;
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: opacity 0.2s;
        }

        .btn:hover {
            opacity: 0.8;
        }

        .btn-primary {
            background: var(--primary-color, #3b82f6);
            color: white;
        }

        .btn-secondary {
            background: var(--gray-200, #e5e7eb);
            color: var(--gray-700, #374151);
        }
    </style>
</head>
<body>
<!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
<div id="loading-indicator">
    <div class="loading-content">
        <div class="loading loading-spinner"></div>
        <p class="loading-text">æ­£åœ¨åŠ è½½åº”ç”¨...</p>
        <div class="loading-progress" id="loading-progress"></div>
    </div>
</div>

<script type="text/javascript">
    /**
     * DagFlow åº”ç”¨åŠ è½½å™¨
     * è´Ÿè´£æŒ‰æ­£ç¡®é¡ºåºåŠ è½½æ‰€æœ‰ä¾èµ–èµ„æºå¹¶åˆå§‹åŒ–åº”ç”¨
     */
    (function() {
        'use strict';

        // ============ é…ç½®éƒ¨åˆ† ============
        
        /**
         * è·å–åº”ç”¨åŸºç¡€è·¯å¾„
         * @returns {string} åŸºç¡€è·¯å¾„
         */
        function getBasePath() {
            const currentUrl = new URL(window.location.href);
            const pathSegments = currentUrl.pathname.split('/');
            
            // ç§»é™¤æ–‡ä»¶åéƒ¨åˆ†
            if (pathSegments[pathSegments.length - 1].includes('.')) {
                pathSegments.pop();
            }
            
            let basePath = pathSegments.join('/');
            
            // ç§»é™¤å°¾éƒ¨æ–œæ 
            if (basePath.endsWith('/')) {
                basePath = basePath.slice(0, -1);
            }
            
            return basePath;
        }

        // åº”ç”¨é…ç½®å¯¹è±¡
        const AppConfig = {
            hostname: window.location.hostname,
            protocol: window.location.protocol,
            basePath: getBasePath(),
            port: window.location.port || (window.location.protocol === 'https:' ? '443' : '80'),
            
            get wsProtocol() {
                return this.protocol === 'https:' ? 'wss' : 'ws';
            },
            
            get baseUrl() {
                return `${this.protocol}//${this.hostname}:${this.port}${this.basePath}`;
            },
            
            get wsBaseUrl() {
                return `${this.wsProtocol}://${this.hostname}:${this.port}${this.basePath}`;
            },
            
            api: {
                event: '/api/v1/event',
                task: '/api/v1/task',
                pipeline: '/api/v1/pipeline'
            }
        };

        // æš´éœ²å¿…è¦çš„å…¨å±€å˜é‡ä¾› main.js ä½¿ç”¨
        window.baseUrl = AppConfig.baseUrl;
        window.wsBaseUrl = AppConfig.wsBaseUrl;
        window.taskUrl = AppConfig.api.task;
        window.pipelineUrl = AppConfig.api.pipeline;
        window.eventUrl = AppConfig.api.event;
        
        // å…¨å±€å˜é‡å£°æ˜
        window.monaco = null;
        window.G6 = null;

        // ============ èµ„æºåŠ è½½å™¨ ============
        
        /**
         * èµ„æºåŠ è½½é…ç½®
         */
        const ResourceLoader = {
            // åŠ è½½è¿›åº¦è¿½è¸ª
            progress: {
                total: 6,
                loaded: 0,
                resources: []
            },

            /**
             * æ›´æ–°åŠ è½½è¿›åº¦
             * @param {string} resourceName - èµ„æºåç§°
             */
            updateProgress(resourceName) {
                this.progress.loaded++;
                this.progress.resources.push(resourceName);
                
                const progressEl = document.getElementById('loading-progress');
                if (progressEl) {
                    const percent = Math.round((this.progress.loaded / this.progress.total) * 100);
                    progressEl.textContent = `${resourceName} (${percent}%)`;
                }
            },

            /**
             * åŠ è½½CSSæ–‡ä»¶
             * @param {string} filename - CSSæ–‡ä»¶è·¯å¾„
             * @returns {Promise<void>}
             */
            loadCSS(filename) {
                return new Promise((resolve, reject) => {
                    const link = document.createElement('link');
                    link.rel = 'stylesheet';
                    link.href = filename;
                    
                    link.onload = () => {
                        this.updateProgress('æ ·å¼');
                        resolve();
                    };
                    
                    link.onerror = () => {
                        reject(new Error(`CSS åŠ è½½å¤±è´¥: ${filename}`));
                    };
                    
                    document.head.appendChild(link);
                });
            },

            /**
             * åŠ è½½JavaScriptæ–‡ä»¶
             * @param {string} filename - JSæ–‡ä»¶è·¯å¾„
             * @param {string} name - èµ„æºæ˜¾ç¤ºåç§°
             * @returns {Promise<void>}
             */
            loadJS(filename, name = 'JavaScript') {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = filename;
                    
                    script.onload = () => {
                        this.updateProgress(name);
                        resolve();
                    };
                    
                    script.onerror = () => {
                        reject(new Error(`JS åŠ è½½å¤±è´¥: ${filename}`));
                    };
                    
                    document.body.appendChild(script);
                });
            },

            /**
             * é…ç½®å¹¶åŠ è½½Monaco Editor
             * @returns {Promise<void>}
             */
            setupMonacoEditor() {
                return new Promise((resolve, reject) => {
                    try {
                        // åˆå§‹åŒ–requireé…ç½®
                        window.require = window.require || {};
                        window.require.config = window.require.config || function() {};

                        // é…ç½®Monaco Editorè·¯å¾„ï¼ˆä»…é…ç½®ä¸€æ¬¡ï¼‰
                        if (!window.require.config._configured) {
                            window.require.config({
                                paths: { 'vs': AppConfig.baseUrl + '/vs' }
                            });
                            window.require.config._configured = true;
                        }

                        // å¦‚æœå·²åŠ è½½ï¼Œç›´æ¥è¿”å›
                        if (window.monaco) {
                            this.updateProgress('Monaco Editor');
                            resolve();
                            return;
                        }

                        // åŠ è½½Monaco Editorä¸»æ¨¡å—
                        window.require(['vs/editor/editor.main'], (monaco) => {
                            window.monaco = monaco;
                            this.updateProgress('Monaco Editor');
                            console.log('Monaco Editor åŠ è½½å®Œæˆ');
                            resolve();
                        }, (error) => {
                            reject(new Error(`Monaco Editor åŠ è½½å¤±è´¥: ${error.message}`));
                        });
                    } catch (error) {
                        reject(error);
                    }
                });
            },

            /**
             * æŒ‰é¡ºåºåŠ è½½æ‰€æœ‰èµ„æº
             * @returns {Promise<void>}
             */
            async loadAll() {
                const baseUrl = AppConfig.baseUrl;

                // 1. åŠ è½½CSS
                await this.loadCSS(`${baseUrl}/css/main.css`);

                // 2. åŠ è½½ tus.js (å¿…é¡»åœ¨AMDåŠ è½½å™¨ä¹‹å‰)
                await this.loadJS(`${baseUrl}/js/tus.js`, 'tus.js');

                // 3. åŠ è½½ G6 å›¾å½¢åº“
                await this.loadJS(`${baseUrl}/js/g6.min.js`, 'G6');

                // 4. åŠ è½½ Monaco Editor loader
                await this.loadJS(`${baseUrl}/vs/loader.js`, 'Monaco Loader');

                // 5. é…ç½®å¹¶åŠ è½½ Monaco Editor
                await this.setupMonacoEditor();

                // 6. åŠ è½½ä¸»åº”ç”¨
                await this.loadJS(`${baseUrl}/js/main.js`, 'ä¸»åº”ç”¨');

                console.log('æ‰€æœ‰èµ„æºåŠ è½½å®Œæˆ');
            }
        };

        // ============ åº”ç”¨åˆå§‹åŒ– ============

        /**
         * åº”ç”¨ç®¡ç†å™¨
         */
        const AppManager = {
            /**
             * éªŒè¯ä¾èµ–æ˜¯å¦æ­£ç¡®åŠ è½½
             * @throws {Error} å¦‚æœä¾èµ–æœªæ­£ç¡®åŠ è½½
             */
            validateDependencies() {
                if (!window.G6) {
                    throw new Error('G6 å›¾å½¢åº“æœªæ­£ç¡®åŠ è½½');
                }
                if (!window.monaco) {
                    throw new Error('Monaco Editor æœªæ­£ç¡®åŠ è½½');
                }
                if (typeof Main === 'undefined') {
                    throw new Error('ä¸»åº”ç”¨ç±» Main æœªå®šä¹‰');
                }
            },

            /**
             * æ˜¾ç¤ºé”™è¯¯ç•Œé¢
             * @param {Error} error - é”™è¯¯å¯¹è±¡
             */
            showError(error) {
                console.error('åº”ç”¨å¯åŠ¨å¤±è´¥:', error);
                
                const errorHtml = `
                    <div class="error-container">
                        <div class="error-content">
                            <h2 class="error-title">åº”ç”¨å¯åŠ¨å¤±è´¥</h2>
                            <p class="error-message">æ— æ³•åŠ è½½ DagFlow åº”ç”¨ï¼Œè¯·å°è¯•ä»¥ä¸‹æ“ä½œï¼š</p>
                            <ul style="text-align: left; color: var(--gray-600, #6b7280); margin: 16px 0;">
                                <li>åˆ·æ–°é¡µé¢é‡è¯•</li>
                                <li>æ¸…é™¤æµè§ˆå™¨ç¼“å­˜</li>
                                <li>æ£€æŸ¥ç½‘ç»œè¿æ¥</li>
                                <li>è”ç³»ç³»ç»Ÿç®¡ç†å‘˜</li>
                            </ul>
                            ${error.message ? `<div class="error-details">é”™è¯¯è¯¦æƒ…: ${error.message}</div>` : ''}
                            <div class="error-actions">
                                <button class="btn btn-primary" onclick="location.reload()">åˆ·æ–°é¡µé¢</button>
                                <button class="btn btn-secondary" onclick="console.log(${JSON.stringify(error)})">æŸ¥çœ‹è¯¦æƒ…</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.innerHTML = errorHtml;
            },

            /**
             * éšè—åŠ è½½æŒ‡ç¤ºå™¨
             */
            hideLoadingIndicator() {
                const loadingIndicator = document.getElementById('loading-indicator');
                if (loadingIndicator) {
                    // å»¶è¿Ÿéšè—ä»¥ç¡®ä¿å¹³æ»‘è¿‡æ¸¡
                    setTimeout(() => {
                        loadingIndicator.style.opacity = '0';
                        setTimeout(() => {
                            loadingIndicator.remove();
                        }, 300);
                    }, 500);
                }
            },

            /**
             * åˆå§‹åŒ–åº”ç”¨
             */
            async init() {
                try {
                    // åŠ è½½æ‰€æœ‰èµ„æº
                    await ResourceLoader.loadAll();

                    // éªŒè¯ä¾èµ–
                    this.validateDependencies();

                    // åˆå§‹åŒ–ä¸»åº”ç”¨
                    console.log('å¼€å§‹åˆå§‹åŒ–ä¸»åº”ç”¨...');
                    new Main();
                    console.log('DagFlow åº”ç”¨å·²æˆåŠŸå¯åŠ¨');

                    // éšè—åŠ è½½æŒ‡ç¤ºå™¨
                    this.hideLoadingIndicator();
                } catch (error) {
                    // æ˜¾ç¤ºé”™è¯¯ç•Œé¢
                    this.showError(error);
                }
            }
        };

        // ============ å…¨å±€é”™è¯¯å¤„ç† ============

        /**
         * å…¨å±€é”™è¯¯å¤„ç†å™¨
         */
        window.addEventListener('error', (event) => {
            console.error('å…¨å±€é”™è¯¯:', {
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                error: event.error
            });
        });

        /**
         * Promise é”™è¯¯å¤„ç†å™¨
         */
        window.addEventListener('unhandledrejection', (event) => {
            console.error('æœªå¤„ç†çš„ Promise é”™è¯¯:', {
                reason: event.reason,
                promise: event.promise
            });
        });

        // ============ åº”ç”¨å…¥å£ ============

        /**
         * DOM åŠ è½½å®Œæˆåå¯åŠ¨åº”ç”¨
         */
        document.addEventListener('DOMContentLoaded', () => {
            AppManager.init();
        });

    })();
</script>
</body>
</html>

