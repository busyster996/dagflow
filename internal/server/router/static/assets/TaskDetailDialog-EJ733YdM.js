import{af as le,aF as ye,s as N,o as ee,m as L,aV as $e,au as Ze,aW as Ye,c as $,a as b,h as n,A as D,b as o,f as c,C as R,R as me,a6 as te,q as se,G as S,r as be,j as h,ac as Be,ab as Ie,y as ke,a9 as Je,w as X,v as Le,S as oe,aJ as Oe,p as ie,L as Z,F as re,a3 as Xe,l as Qe,ag as ue,aq as De,aK as Ae,aI as We,aX as et,aN as Re,x as ge,aR as je,aY as Ce,aZ as Pe,aM as tt,a_ as at,a$ as nt,ai as Se,b0 as ot,b1 as st,b2 as lt,b3 as ct,b4 as it,b5 as rt,b6 as ut,b7 as dt,ae as mt}from"./element-plus-D2VUXABr.js";import"./index-DmKw4XXH.js";import{b as ft,c as xe,I as K,S as Fe,a as Q,E as Ee}from"./el-card-gthh8NLS.js";import{A as qe,a as Y,W as pt,_ as ae}from"./_plugin-vue_export-helper-ySprrkWw.js";import{E as J,s as vt,H as ht,t as f,a as fe,l as gt,h as _t,b as yt,c as bt,f as kt,d as wt,e as $t,i as Ct,g as St,j as xt,k as Et,r as Tt,m as Mt,n as Nt,o as Vt,p as zt,C as pe,q as Bt,u as It,v as Lt,w as Ot,x as Dt,y as At,z as Wt,A as Rt,B as ve}from"./codemirror-CauJjIGm.js";import{u as jt,_ as Pt,a as Ft,b as qt,c as Ut,M as Gt}from"./vue-flow-DmkpiIJk.js";async function ce(e,t={}){try{const l=await fetch(`${qe}${e}`,{headers:{"Content-Type":"application/json",...t.headers},...t});if(!l.ok)throw new Error(`HTTP ${l.status}: ${l.statusText}`);return await l.json()}catch(l){throw console.error("API请求失败:",l),le.error(`请求失败: ${l.message}`),l}}async function Ht(e,t,l="POST"){try{const a=await fetch(`${qe}${e}`,{method:l,headers:{"Content-Type":"application/yaml"},body:t}),i=await a.json();if(!a.ok||i.code!==0)throw new Error(i.message||"请求失败");return i}catch(a){throw console.error("YAML请求失败:",a),le.error(`请求失败: ${a.message}`),a}}function Kt(e){return ce(`${Y.task}/${e}`)}function qn(e){return Ht(Y.task,e,"POST")}async function Un(e,t){if(await ye.confirm(`确定要${t} "${e}"?`,"确认操作",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).catch(()=>!1))try{const a=await ce(`${Y.task}/${e}?action=${t}`,{method:"PUT"});return le.success(`${t}操作成功`),a}catch(a){throw a}}async function Gn(e){if(await ye.confirm(`确定要删除任务 "${e}"?`,"确认删除",{confirmButtonText:"删除",cancelButtonText:"取消",type:"warning",confirmButtonClass:"el-button--danger"}).catch(()=>!1))try{await ce(`${Y.task}/${e}`,{method:"DELETE"}),le.success("任务删除成功")}catch(l){throw l}}async function Hn(e){try{const t=await ce(`${Y.task}/${e}/dump`),l=new Blob([t.data],{type:"application/yaml"}),a=window.URL.createObjectURL(l),i=document.createElement("a");i.href=a,i.download=`${e}.yaml`,i.click(),window.URL.revokeObjectURL(a),le.success("任务配置导出成功")}catch(t){throw t}}async function Zt(e,t,l){if(await ye.confirm(`确定要${l} "${t}"?`,"确认操作",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).catch(()=>!1))try{const i=await ce(`${Y.task}/${e}/step/${t}?action=${l}`,{method:"PUT"});return le.success(`${l}操作成功`),i}catch(i){throw i}}function Yt(e,t){return ce(`${Y.task}/${e}/step/${t}`)}class Jt{constructor(t,l,a=null,i={}){this.url=`${pt}${t}`,this.onMessage=l,this.onError=a,this.reconnectInterval=i.reconnectInterval||5e3,this.maxReconnectAttempts=i.maxReconnectAttempts||5,this.socket=null,this.isManuallyClosed=!1,this.reconnectAttempts=0,this.connect()}connect(){this.socket&&(this.socket.readyState===WebSocket.OPEN||this.socket.readyState===WebSocket.CONNECTING)||(this.isManuallyClosed=!1,this.socket=new WebSocket(this.url),this.socket.onopen=()=>{this.reconnectAttempts=0},this.socket.onmessage=t=>{try{const l=JSON.parse(t.data);this.onMessage(l)}catch(l){console.error("解析WebSocket消息失败:",l)}},this.socket.onerror=t=>{console.error("WebSocket错误:",t),this.onError&&this.onError(t)},this.socket.onclose=t=>{t.wasClean||(console.log(`WebSocket意外关闭: ${t.code}, ${t.reason}`),this.handleReconnect())})}handleReconnect(){if(this.isManuallyClosed||this.reconnectAttempts>=this.maxReconnectAttempts)return;this.reconnectAttempts++;const t=Math.min(this.reconnectInterval*Math.pow(2,this.reconnectAttempts-1),3e4);console.log(`尝试重连 (${this.reconnectAttempts}/${this.maxReconnectAttempts})...`),setTimeout(()=>{this.connect()},t)}send(t){this.socket&&this.socket.readyState===WebSocket.OPEN?this.socket.send(JSON.stringify(t)):console.warn("WebSocket未连接，无法发送数据")}close(){this.isManuallyClosed=!0,this.socket&&(this.socket.close(1e3,"正常关闭"),this.socket=null)}}function Xt(e,t={}){const{onMessage:l,onError:a,onOpen:i,onClose:k,reconnectInterval:s,maxReconnectAttempts:g}=t,m=N(!1),r=N(!1),d=N(null),C=N(null);let _=null;const V=()=>{_&&_.close(),r.value=!0,d.value=null;const A=p=>{C.value=p,l&&l(p)},P=p=>{d.value=p,m.value=!1,r.value=!1,a&&a(p)};_=new Jt(e,A,P,{reconnectInterval:s,maxReconnectAttempts:g});const y=setInterval(()=>{if(_&&_.socket){if(_.socket.readyState===WebSocket.OPEN)m.value=!0,r.value=!1,i&&!m.value&&i();else if(_.socket.readyState===WebSocket.CLOSED){const p=m.value;m.value=!1,r.value=!1,k&&p&&k()}}},100);ee(()=>{clearInterval(y)})},T=A=>{_&&_.send(A)},x=()=>{_&&(_.close(),_=null,m.value=!1,r.value=!1)},O=()=>{x(),V()},j=()=>!_||!_.socket?WebSocket.CLOSED:_.socket.readyState;return ee(()=>{x()}),{isConnected:m,isConnecting:r,error:d,data:C,connect:V,send:T,close:x,reconnect:O,getReadyState:j}}function Ue(e,t={}){const l=N([]),a=N(!1),i=N({current:1,size:15,total:1}),s=Xt(e,{...t,onMessage:d=>{d.data?(Array.isArray(d.data)?l.value=d.data:d.data.list||d.data.items?l.value=d.data.list||d.data.items:d.data.tasks?l.value=d.data.tasks:d.data.pipelines&&(l.value=d.data.pipelines),d.data.page&&(i.value={current:d.data.page.current||1,size:d.data.page.size||15,total:d.data.page.total||1})):l.value=[],a.value=!1,t.onMessage&&t.onMessage(d)}}),g=(d={})=>{a.value=!0;const C={page:i.value.current,size:i.value.size,...d};s.send(C)};return{...s,items:l,loading:a,pagination:i,refresh:g,changePage:d=>{i.value.current=d,g()},changePageSize:d=>{i.value.size=d,i.value.current=1,g()}}}function Kn(e){const t=L(()=>{const s={total:0,running:0,stopped:0,failed:0,pending:0,timeout:0,canceled:0,skipped:0,paused:0,killed:0};return!e||!e.value||!Array.isArray(e.value)||(s.total=e.value.length,e.value.forEach(g=>{const m=g.state||"unknown";s[m]!==void 0&&s[m]++})),s}),l=L(()=>t.value.total===0?0:(t.value.stopped/t.value.total*100).toFixed(1)),a=L(()=>t.value.total===0?0:((t.value.failed+t.value.timeout+t.value.killed)/t.value.total*100).toFixed(1)),i=L(()=>t.value.running+t.value.pending+t.value.paused),k=L(()=>t.value.stopped+t.value.failed+t.value.timeout+t.value.canceled+t.value.skipped+t.value.killed);return{stats:t,successRate:l,failureRate:a,activeCount:i,completedCount:k}}function Zn(e){const t=L(()=>{const a={total:0,enabled:0,disabled:0,jinja:0,yaml:0};return!e||!e.value||!Array.isArray(e.value)||(a.total=e.value.length,e.value.forEach(i=>{i.disable?a.disabled++:a.enabled++,i.tplType==="jinja2"?a.jinja++:a.yaml++})),a}),l=L(()=>t.value.total===0?0:(t.value.enabled/t.value.total*100).toFixed(1));return{stats:t,enabledRate:l}}const Qt={class:"stat-content"},ea={class:"stat-label"},ta={class:"stat-value"},aa={key:0,class:"stat-sublabel"},na={__name:"StatCard",props:{icon:{type:Object,required:!0},label:{type:String,required:!0},value:{type:[Number,String],required:!0},subLabel:{type:String,default:""},variant:{type:String,default:"primary",validator:e=>["primary","success","warning","danger","info","running","failed","active","disabled","jinja","total"].includes(e)},clickable:{type:Boolean,default:!1},isLoading:{type:Boolean,default:!1},iconSize:{type:Number,default:24},trend:{type:String,default:""},trendDirection:{type:String,default:"neutral",validator:e=>["up","down","neutral"].includes(e)},formatValue:{type:Boolean,default:!0}},emits:["click"],setup(e,{emit:t}){const l=e,a=t,i=L(()=>typeof l.value=="string"?l.value:l.formatValue?ft(l.value):l.value),k=L(()=>({up:Ye,down:Ze,neutral:$e})[l.trendDirection]||$e),s=()=>{l.clickable&&!l.isLoading&&a("click")};return(g,m)=>{const r=te;return b(),$("div",{class:se(["stat-card",{clickable:e.clickable,loading:e.isLoading}]),onClick:s},[n("div",{class:se(["stat-icon",e.variant])},[o(r,{size:e.iconSize},{default:c(()=>[(b(),R(me(e.icon)))]),_:1},8,["size"])],2),n("div",Qt,[n("p",ea,S(e.label),1),n("h3",ta,S(e.isLoading?"...":i.value),1),e.subLabel?(b(),$("p",aa,S(e.subLabel),1)):D("",!0)]),e.trend?(b(),$("div",{key:0,class:se(["stat-trend",e.trendDirection])},[o(r,null,{default:c(()=>[(b(),R(me(k.value)))]),_:1}),n("span",null,S(e.trend),1)],2)):D("",!0)],2)}}},Yn=ae(na,[["__scopeId","data-v-e6b80589"]]),oa={class:"modern-dialog-header"},sa={class:"header-left"},la={key:0,class:"header-icon-wrapper"},ca={class:"header-title"},ia={class:"header-right"},ra={__name:"DialogHeader",props:{title:{type:String,required:!0},icon:{type:Object,default:null},showClose:{type:Boolean,default:!0}},emits:["close"],setup(e,{emit:t}){const l=t,a=()=>{l("close")};return(i,k)=>{const s=te,g=Ie;return b(),$("div",oa,[n("div",sa,[e.icon?(b(),$("div",la,[o(s,{class:"header-icon"},{default:c(()=>[(b(),R(me(e.icon)))]),_:1})])):D("",!0),n("h2",ca,S(e.title),1)]),n("div",ia,[be(i.$slots,"actions",{},()=>[e.showClose?(b(),R(g,{key:0,type:"danger",icon:h(Be),circle:"",size:"small",onClick:a,class:"close-button"},null,8,["icon"])):D("",!0)],!0)])])}}},ua=ae(ra,[["__scopeId","data-v-3910f541"]]),da="#e5c07b",Te="#e06c75",ma="#56b6c2",fa="#ffffff",de="#abb2bf",_e="#7d8799",pa="#61afef",va="#98c379",Me="#d19a66",ha="#c678dd",ga="#21252b",Ne="#2c313a",Ve="#282c34",he="#353a42",_a="#3E4451",ze="#528bff",ya=J.theme({"&":{color:de,backgroundColor:Ve},".cm-content":{caretColor:ze},".cm-cursor, .cm-dropCursor":{borderLeftColor:ze},"&.cm-focused > .cm-scroller > .cm-selectionLayer .cm-selectionBackground, .cm-selectionBackground, .cm-content ::selection":{backgroundColor:_a},".cm-panels":{backgroundColor:ga,color:de},".cm-panels.cm-panels-top":{borderBottom:"2px solid black"},".cm-panels.cm-panels-bottom":{borderTop:"2px solid black"},".cm-searchMatch":{backgroundColor:"#72a1ff59",outline:"1px solid #457dff"},".cm-searchMatch.cm-searchMatch-selected":{backgroundColor:"#6199ff2f"},".cm-activeLine":{backgroundColor:"#6699ff0b"},".cm-selectionMatch":{backgroundColor:"#aafe661a"},"&.cm-focused .cm-matchingBracket, &.cm-focused .cm-nonmatchingBracket":{backgroundColor:"#bad0f847"},".cm-gutters":{backgroundColor:Ve,color:_e,border:"none"},".cm-activeLineGutter":{backgroundColor:Ne},".cm-foldPlaceholder":{backgroundColor:"transparent",border:"none",color:"#ddd"},".cm-tooltip":{border:"none",backgroundColor:he},".cm-tooltip .cm-tooltip-arrow:before":{borderTopColor:"transparent",borderBottomColor:"transparent"},".cm-tooltip .cm-tooltip-arrow:after":{borderTopColor:he,borderBottomColor:he},".cm-tooltip-autocomplete":{"& > ul > li[aria-selected]":{backgroundColor:Ne,color:de}}},{dark:!0}),ba=ht.define([{tag:f.keyword,color:ha},{tag:[f.name,f.deleted,f.character,f.propertyName,f.macroName],color:Te},{tag:[f.function(f.variableName),f.labelName],color:pa},{tag:[f.color,f.constant(f.name),f.standard(f.name)],color:Me},{tag:[f.definition(f.name),f.separator],color:de},{tag:[f.typeName,f.className,f.number,f.changed,f.annotation,f.modifier,f.self,f.namespace],color:da},{tag:[f.operator,f.operatorKeyword,f.url,f.escape,f.regexp,f.link,f.special(f.string)],color:ma},{tag:[f.meta,f.comment],color:_e},{tag:f.strong,fontWeight:"bold"},{tag:f.emphasis,fontStyle:"italic"},{tag:f.strikethrough,textDecoration:"line-through"},{tag:f.link,color:_e,textDecoration:"underline"},{tag:f.heading,fontWeight:"bold",color:Te},{tag:[f.atom,f.bool,f.special(f.variableName)],color:Me},{tag:[f.processingInstruction,f.string,f.inserted],color:va},{tag:f.invalid,color:fa}]),ka=[ya,vt(ba)];function wa(e={}){const{language:t="yaml",theme:l="dark",readOnly:a=!1,initialValue:i="",editorOptions:k={}}=e;let s=null,g=!1;const m=new pe,r=new pe,d=new pe,C=v=>{switch(v){case"yaml":return ve();case"json":return ve();default:return ve()}},_=v=>v==="dark"?ka:[],V=()=>[gt(),_t(),yt(),bt(),kt(),wt(),$t(),fe.allowMultipleSelections.of(!0),Ct(),St(),xt(),Et(),Tt(),Mt(),Nt(),Vt(),zt.of([...Bt,...It,...Lt,...Ot,...Dt,...At,...Wt,Rt])],T=async(v,M=i)=>{if(!v){console.warn("CodeMirror editor container not found");return}s&&(s.destroy(),s=null),await ke();try{const q=fe.create({doc:M||"",extensions:[...V(),m.of(C(t)),r.of(J.editable.of(!a)),d.of(_(l)),J.lineWrapping,...k.extensions||[]]});s=new J({state:q,parent:v}),g=!0}catch(q){console.error("Failed to initialize CodeMirror Editor:",q)}},x=()=>s?s.state.doc.toString():"",O=v=>{if(!s)return;const M=s.state.update({changes:{from:0,to:s.state.doc.length,insert:v||""}});s.dispatch(M)},j=v=>{if(!s)return;const M=x(),q=M+(M?`
`:"")+v;O(q),u()},A=()=>{O("")},P=v=>{s&&s.dispatch({effects:r.reconfigure(J.editable.of(!v))})},y=v=>{s&&s.dispatch({effects:m.reconfigure(C(v))})},p=v=>{s&&s.dispatch({effects:d.reconfigure(_(v))})},E=()=>{s&&console.log("CodeMirror formatDocument - not implemented")},F=()=>{s&&s.focus()},ne=()=>{s&&s.requestMeasure()},w=()=>{s&&s.dispatch({effects:J.scrollIntoView(0,{y:"start"})})},u=()=>{if(!s)return;const v=s.state.doc.length;s.dispatch({effects:J.scrollIntoView(v,{y:"end"})})},z=()=>{if(!s)return"";const v=s.state.selection.main;return s.state.doc.sliceString(v.from,v.to)},I=v=>{if(!s)return;const M=s.state.selection.main;s.dispatch({changes:{from:M.from,to:M.to,insert:v},selection:{anchor:M.from+v.length}})},U=v=>{if(!s)return()=>{};const M=J.updateListener.of(q=>{q.docChanged&&v(x())});return s.dispatch({effects:fe.appendConfig.of(M)}),()=>{}},W=()=>{s&&(s.destroy(),s=null,g=!1)},B=()=>s,G=()=>g;return ee(()=>{W()}),{initEditor:T,getValue:x,setValue:O,appendValue:j,clear:A,setReadOnly:P,setLanguage:y,setTheme:p,formatDocument:E,focus:F,layout:ne,scrollToTop:w,scrollToBottom:u,getSelectedText:z,insertText:I,onContentChange:U,dispose:W,getEditor:B,isEditorInitialized:G}}const $a={class:"codemirror-editor-wrapper"},Ca={key:0,class:"editor-toolbar"},Sa={class:"toolbar-left"},xa={class:"toolbar-title"},Ea={class:"toolbar-right"},Ta={__name:"CodeMirrorEditor",props:{modelValue:{type:String,default:""},language:{type:String,default:"yaml"},theme:{type:String,default:"dark"},readOnly:{type:Boolean,default:!1},height:{type:[String,Number],default:"100%"},showToolbar:{type:Boolean,default:!0},title:{type:String,default:"代码编辑器"},toolbarIcon:{type:Object,default:()=>Je},options:{type:Object,default:()=>({})}},emits:["update:modelValue","change","ready"],setup(e,{expose:t,emit:l}){const a=e,i=l,k=N(null),{initEditor:s,getValue:g,setValue:m,onContentChange:r,dispose:d,getEditor:C,setReadOnly:_,setLanguage:V,setTheme:T,focus:x,formatDocument:O}=wa({language:a.language,theme:a.theme,readOnly:a.readOnly,initialValue:a.modelValue,editorOptions:a.options}),j=L(()=>({height:typeof a.height=="number"?`${a.height}px`:a.height})),A=L(()=>({yaml:"info",json:"success",javascript:"warning",typescript:"primary"})[a.language]||"info"),P=L(()=>a.language.toUpperCase());return X(()=>a.modelValue,y=>{const p=g();y!==p&&m(y)}),X(()=>a.language,y=>{V(y)}),X(()=>a.theme,y=>{T(y)}),X(()=>a.readOnly,y=>{_(y)}),Le(async()=>{k.value&&(await s(k.value,a.modelValue),r(y=>{i("update:modelValue",y),i("change",y)}),i("ready",C()))}),ee(()=>{d()}),t({getValue:g,setValue:m,getEditor:C,focus:()=>x(),format:()=>O()}),(y,p)=>{const E=te,F=Oe;return b(),$("div",$a,[e.showToolbar?(b(),$("div",Ca,[n("div",Sa,[o(E,{class:"toolbar-icon"},{default:c(()=>[(b(),R(me(e.toolbarIcon)))]),_:1}),n("span",xa,S(e.title),1)]),n("div",Ea,[o(F,{size:"small",type:A.value},{default:c(()=>[oe(S(P.value),1)]),_:1},8,["type"]),be(y.$slots,"toolbar-actions",{},void 0,!0)])])):D("",!0),n("div",{ref_key:"containerRef",ref:k,class:"codemirror-editor-container",style:ie(j.value)},null,4)])}}},Jn=ae(Ta,[["__scopeId","data-v-31eb834f"]]),Ma={__name:"CardGrid",props:{columns:{type:[Number,String,Object],default:"auto",validator:e=>typeof e=="number"?e>0&&e<=12:typeof e=="string"?e==="auto":typeof e=="object"},minColumnWidth:{type:[String,Number],default:340},gap:{type:String,default:"var(--spacing-base)"},compact:{type:Boolean,default:!1},bordered:{type:Boolean,default:!1}},setup(e){const t=e,l=L(()=>{let a;return t.columns==="auto"?a=`repeat(auto-fill, minmax(${typeof t.minColumnWidth=="number"?`${t.minColumnWidth}px`:t.minColumnWidth}, 1fr))`:typeof t.columns=="number"?a=`repeat(${t.columns}, 1fr)`:typeof t.columns=="object"&&(a=`repeat(auto-fill, minmax(${t.minColumnWidth}px, 1fr))`),{gridTemplateColumns:a,gap:t.gap}});return(a,i)=>(b(),$("div",{class:se(["card-grid",[`cols-${e.columns}`,{compact:e.compact,bordered:e.bordered}]]),style:ie(l.value)},[be(a.$slots,"default",{},void 0,!0)],6))}},Xn=ae(Ma,[["__scopeId","data-v-429a1400"]]),Na={key:0,class:"status-pulse"},Va={class:"node-header"},za={class:"header-content"},Ba=["title"],Ia={class:"step-type"},La={class:"node-body"},Oa={class:"info-section"},Da={class:"info-row"},Aa={key:0,class:"info-item"},Wa={class:"info-item"},Ra={class:"status-text"},ja={class:"time-section"},Pa={class:"time-row"},Fa={class:"time-item"},qa={class:"time-content"},Ua={class:"time-value"},Ga={class:"time-row"},Ha={class:"time-item"},Ka={class:"time-content"},Za={class:"time-value"},Ya={class:"node-actions"},Ja={__name:"CustomNode",props:{data:{type:Object,required:!0}},setup(e){const t=e,l=L(()=>xe[t.data.step.state]||xe.unknown),a=L(()=>{const m=l.value;return`linear-gradient(90deg, ${m} 0%, ${i(m,20)} 100%)`}),i=(m,r)=>{const d=x=>Math.min(Math.max(x,0),255),C=parseInt(m.replace("#",""),16),_=d((C>>16)+r),V=d((C>>8&255)+r),T=d((C&255)+r);return"#"+(_<<16|V<<8|T).toString(16).padStart(6,"0")},k=m=>({pending:"待执行",running:"执行中",stopped:"已停止",failed:"已失败",success:"成功",paused:"已暂停",killed:"已终止",timeout:"超时",canceled:"已取消",skipped:"已跳过"})[m]||m,s=()=>{const m=t.data.step.code;return m===0?"success":m>0?"error":"default"},g=m=>{if(!m)return"---";if(typeof m=="string"&&m.includes(":")){const r=m.match(/(\d{2}):(\d{2}):(\d{2})/);return r?`${r[1]}:${r[2]}:${r[3]}`:m}return m};return(m,r)=>{var x,O;const d=Z("Setting"),C=te,_=Z("Timer"),V=Z("Calendar"),T=Z("More");return b(),$("div",{class:se(["custom-node",`node-${e.data.step.state}`])},[n("div",{class:"status-bar",style:ie({background:a.value})},[e.data.step.state==="running"?(b(),$("div",Na)):D("",!0)],4),n("div",Va,[r[0]||(r[0]=n("div",{class:"header-icon-wrapper"},[n("svg",{class:"step-icon",viewBox:"0 0 24 24",fill:"currentColor"},[n("path",{d:"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"})])],-1)),n("div",za,[n("h3",{class:"step-name",title:e.data.step.name},S(e.data.step.name),9,Ba),n("div",Ia,[o(C,null,{default:c(()=>[o(d)]),_:1}),n("span",null,S(e.data.step.type||"exec"),1)])])]),n("div",La,[n("div",Oa,[n("div",Da,[e.data.step.code!==void 0?(b(),$("div",Aa,[r[1]||(r[1]=n("span",{class:"item-label"},"返回码",-1)),n("span",{class:se(["item-value code",s()])},S(e.data.step.code),3)])):D("",!0),n("div",Wa,[r[3]||(r[3]=n("span",{class:"item-label"},"状态",-1)),n("div",{class:"status-badge",style:ie({background:l.value})},[r[2]||(r[2]=n("span",{class:"status-dot"},null,-1)),n("span",Ra,S(k(e.data.step.state)),1)],4)])])]),r[6]||(r[6]=n("div",{class:"node-divider"},null,-1)),n("div",ja,[n("div",Pa,[n("div",Fa,[o(C,{class:"time-icon"},{default:c(()=>[o(_)]),_:1}),n("div",qa,[r[4]||(r[4]=n("span",{class:"time-label"},"开始",-1)),n("span",Ua,S(g((x=e.data.step.time)==null?void 0:x.start)),1)])])]),n("div",Ga,[n("div",Ha,[o(C,{class:"time-icon"},{default:c(()=>[o(V)]),_:1}),n("div",Ka,[r[5]||(r[5]=n("span",{class:"time-label"},"结束",-1)),n("span",Za,S(g((O=e.data.step.time)==null?void 0:O.end)),1)])])])])]),n("div",Ya,[o(C,{class:"action-icon"},{default:c(()=>[o(T)]),_:1})])],2)}}},Xa=ae(Ja,[["__scopeId","data-v-5a570e3e"]]),Qa={class:"vue-flow-wrapper"},en={class:"context-menu-header"},tn={class:"context-menu-body"},an={key:3,class:"menu-item disabled"},nn={key:0,class:"graph-stats"},on={class:"stat-item"},sn={class:"stat-value"},ln={class:"stat-item"},cn={class:"stat-value"},rn={__name:"VueFlowGraph",props:{steps:{type:Array,required:!0},taskName:{type:String,required:!0},showToolbar:{type:Boolean,default:!0}},emits:["node-click"],setup(e,{expose:t,emit:l}){const a=e,i=l,k=N([]),s=N([]),g=N({visible:!1,x:0,y:0,step:null,nodeId:null}),m=L(()=>"#c7d2fe"),r=L(()=>k.value.length?{nodes:k.value.length,edges:s.value.length}:null);let d=!0,C={};const{fitView:_,zoomIn:V,zoomOut:T,setViewport:x}=jt(),O=()=>{const w=[],u=[];return a.steps.forEach((z,I)=>{const U={id:z.name,type:"custom",data:{step:z,taskName:a.taskName},position:C[z.name]||{x:0,y:I*120}};w.push(U),z.depends&&z.depends.length>0&&z.depends.forEach(W=>{u.push({id:`${W}-${z.name}`,source:W,target:z.name,type:"smoothstep",animated:z.state==="running",markerEnd:Gt.ArrowClosed,style:{strokeWidth:2,stroke:j(z.state)}})})}),{newNodes:w,newEdges:u}},j=w=>({running:"#667eea",stopped:"#52c41a",failed:"#ff4d4f",pending:"#faad14"})[w]||"#94a3b8",A=async()=>{const{newNodes:w,newEdges:u}=O();d?(k.value=w,s.value=u,await ke(),P(),setTimeout(()=>{k.value.forEach(z=>{C[z.id]={...z.position}}),d=!1},500)):(k.value=w,s.value=u)},P=()=>{const w=new Map,u=new Set,I=a.steps.filter(v=>!v.depends||v.depends.length===0).map(v=>({name:v.name,level:0}));for(;I.length>0;){const{name:v,level:M}=I.shift();if(u.has(v))continue;u.add(v),w.has(M)||w.set(M,[]),w.get(M).push(v),a.steps.filter(H=>H.depends&&H.depends.includes(v)).forEach(H=>{I.push({name:H.name,level:M+1})})}const U=300,W=160,B=150,G=100;w.forEach((v,M)=>{const q=M*(U+B);v.forEach((H,Ge)=>{const He=Ge*(W+G),we=k.value.find(Ke=>Ke.id===H);we&&(we.position={x:q,y:He})})})},y=w=>{const u=w.node.id;i("node-click",u)},p=w=>{w.event.preventDefault();const u=w.node.data.step;g.value={visible:!0,x:w.event.clientX,y:w.event.clientY,step:u,nodeId:w.node.id}},E=async w=>{if(g.value.step)try{await Zt(a.taskName,g.value.step.name,w)}catch(u){console.error("操作失败:",u)}F()},F=()=>{g.value.visible=!1},ne=w=>{g.value.visible&&!w.target.closest(".modern-context-menu")&&F()};return X(()=>a.steps,()=>{A()},{deep:!0}),Le(()=>{A(),document.addEventListener("click",ne)}),ee(()=>{document.removeEventListener("click",ne)}),t({fitView:()=>{_({padding:.2,duration:300})},zoomIn:()=>{V({duration:300})},zoomOut:()=>{T({duration:300})},actualSize:()=>{x({x:0,y:0,zoom:1},{duration:300})}}),(w,u)=>{const z=Z("Operation"),I=te,U=Z("VideoPause"),W=Z("VideoPlay"),B=Z("CirclePause"),G=Z("InfoFilled");return b(),$("div",Qa,[o(h(Ut),{nodes:k.value,"onUpdate:nodes":u[0]||(u[0]=v=>k.value=v),edges:s.value,"onUpdate:edges":u[1]||(u[1]=v=>s.value=v),"default-zoom":1,"min-zoom":.2,"max-zoom":4,"fit-view-on-init":"",onNodeClick:y,onNodeContextMenu:p,class:"modern-vue-flow"},{"node-custom":c(({data:v})=>[o(Xa,{data:v},null,8,["data"])]),default:c(()=>[o(h(Pt),{"pattern-color":m.value,gap:20,variant:"dots"},null,8,["pattern-color"]),e.showToolbar?(b(),R(h(Ft),{key:0,position:"bottom-right"})):D("",!0),e.showToolbar?(b(),R(h(qt),{key:1,position:"bottom-left"})):D("",!0)]),_:1},8,["nodes","edges"]),o(Xe,{name:"context-menu-fade"},{default:c(()=>{var v,M,q;return[g.value.visible?(b(),$("div",{key:0,class:"modern-context-menu",style:ie({left:g.value.x+"px",top:g.value.y+"px"})},[n("div",en,[o(I,{class:"menu-header-icon"},{default:c(()=>[o(z)]),_:1}),u[7]||(u[7]=n("span",null,"步骤操作",-1))]),n("div",tn,[((v=g.value.step)==null?void 0:v.state)==="running"?(b(),$("div",{key:0,class:"menu-item danger",onClick:u[2]||(u[2]=H=>E("kill"))},[o(I,null,{default:c(()=>[o(U)]),_:1}),u[8]||(u[8]=n("span",null,"强制终止",-1))])):((M=g.value.step)==null?void 0:M.state)==="paused"?(b(),$(re,{key:1},[n("div",{class:"menu-item success",onClick:u[3]||(u[3]=H=>E("resume"))},[o(I,null,{default:c(()=>[o(W)]),_:1}),u[9]||(u[9]=n("span",null,"恢复执行",-1))]),n("div",{class:"menu-item danger",onClick:u[4]||(u[4]=H=>E("kill"))},[o(I,null,{default:c(()=>[o(U)]),_:1}),u[10]||(u[10]=n("span",null,"强制终止",-1))])],64)):((q=g.value.step)==null?void 0:q.state)==="pending"?(b(),$(re,{key:2},[n("div",{class:"menu-item warning",onClick:u[5]||(u[5]=H=>E("pause"))},[o(I,null,{default:c(()=>[o(B)]),_:1}),u[11]||(u[11]=n("span",null,"暂停挂起",-1))]),n("div",{class:"menu-item danger",onClick:u[6]||(u[6]=H=>E("kill"))},[o(I,null,{default:c(()=>[o(U)]),_:1}),u[12]||(u[12]=n("span",null,"强制终止",-1))])],64)):(b(),$("div",an,[o(I,null,{default:c(()=>[o(G)]),_:1}),u[13]||(u[13]=n("span",null,"暂无可用操作",-1))]))])],4)):D("",!0)]}),_:1}),r.value?(b(),$("div",nn,[n("div",on,[u[14]||(u[14]=n("span",{class:"stat-label"},"节点",-1)),n("span",sn,S(r.value.nodes),1)]),n("div",ln,[u[15]||(u[15]=n("span",{class:"stat-label"},"连接",-1)),n("span",cn,S(r.value.edges),1)])])):D("",!0)])}}},un={class:"step-content"},dn={key:0,class:"info-grid"},mn={class:"env-list"},fn={class:"env-header"},pn={class:"env-name"},vn={class:"env-value-wrapper"},hn={class:"env-value"},gn={class:"code-content"},_n={__name:"StepContent",props:{taskName:String,stepName:String},setup(e){const t=e,l=N(!1),a=N(null),i=N(""),k=N(null),s=N(null),g=Qe({env:!1,input:!1}),{connect:m,close:r}=Ue(`${Y.task}/${t.taskName}/step/${t.stepName}/log`,{onMessage:_=>{if(_.data&&_.data.length>0){const V=_.data.map(T=>T.content).join(`
`);i.value+=V+`
`,ke(()=>{if(k.value){const T=k.value.$refs.wrap$;T&&(T.scrollTop=T.scrollHeight)}})}},onError:()=>{var _;i.value=((_=a.value)==null?void 0:_.message)||"无输出"}}),d=_=>{g[_]=!g[_]},C=async()=>{l.value=!0;try{const _=await Yt(t.taskName,t.stepName);a.value=_.data}catch(_){console.error("获取步骤详情失败:",_)}finally{l.value=!1}};return X(()=>t.stepName,()=>{t.stepName&&(C(),m())},{immediate:!0}),ee(()=>{r()}),(_,V)=>{var y;const T=Oe,x=We,O=te,j=Re,A=et,P=De;return ue((b(),$("div",un,[o(x,{shadow:"hover",class:"section-card"},{header:c(()=>[o(h(Q),{icon:h(Ae),title:"基本信息"},null,8,["icon"])]),default:c(()=>{var p,E;return[a.value?(b(),$("div",dn,[o(h(K),{label:"步骤名称",value:a.value.name,hoverable:""},null,8,["value"]),o(h(K),{label:"步骤类型",hoverable:""},{value:c(()=>[o(T,{type:"info",size:"small"},{default:c(()=>[oe(S(a.value.type),1)]),_:1})]),_:1}),o(h(K),{label:"步骤状态",hoverable:""},{value:c(()=>[o(h(Fe),{status:a.value.state,effect:"plain",size:"small","show-icon":""},null,8,["status"])]),_:1}),a.value.code!==void 0?(b(),R(h(K),{key:0,label:"状态码",value:a.value.code,"value-class":a.value.code===0?"success":"error",hoverable:""},null,8,["value","value-class"])):D("",!0),o(h(K),{label:"开始时间",value:((p=a.value.time)==null?void 0:p.start)||"---","value-class":"time",hoverable:""},null,8,["value"]),o(h(K),{label:"结束时间",value:((E=a.value.time)==null?void 0:E.end)||"---","value-class":"time",hoverable:""},null,8,["value"])])):D("",!0)]}),_:1}),(y=a.value)!=null&&y.env&&a.value.env.length>0?(b(),R(x,{key:0,shadow:"hover",class:"section-card collapsible-card"},{header:c(()=>[o(h(Q),{icon:h(Pe),title:"环境变量",count:a.value.env.length,clickable:"",expandable:!0,"is-expanded":g.env,onClick:V[0]||(V[0]=p=>d("env"))},null,8,["icon","count","is-expanded"])]),default:c(()=>[o(A,null,{default:c(()=>[ue(n("div",null,[o(j,{"max-height":"300px"},{default:c(()=>[n("div",mn,[(b(!0),$(re,null,ge(a.value.env,(p,E)=>(b(),$("div",{key:E,class:"env-item"},[n("div",fn,[o(O,{class:"env-icon"},{default:c(()=>[o(h(je))]),_:1}),n("span",pn,S(p.name),1)]),n("div",vn,[n("code",hn,S(p.value),1)])]))),128))])]),_:1})],512),[[Ce,g.env]])]),_:1})]),_:1})):D("",!0),o(x,{shadow:"hover",class:"section-card collapsible-card"},{header:c(()=>[o(h(Q),{icon:h(tt),title:"输入内容",clickable:"",expandable:!0,"is-expanded":g.input,onClick:V[1]||(V[1]=p=>d("input"))},null,8,["icon","is-expanded"])]),default:c(()=>[o(A,null,{default:c(()=>[ue(n("div",null,[o(j,{"max-height":"300px"},{default:c(()=>{var p;return[n("pre",gn,S(((p=a.value)==null?void 0:p.content)||"无内容"),1)]}),_:1})],512),[[Ce,g.input]])]),_:1})]),_:1}),o(x,{shadow:"hover",class:"section-card output-card"},{header:c(()=>[o(h(Q),{icon:h(at),title:"执行输出",tag:"实时更新","tag-type":"success"},null,8,["icon"])]),default:c(()=>[o(j,{ref_key:"outputScrollbar",ref:k,class:"output-scrollbar"},{default:c(()=>[n("pre",{ref_key:"outputRef",ref:s,class:"output-content"},S(i.value||"暂无输出"),513)]),_:1},512)]),_:1})])),[[P,l.value]])}}},yn=ae(_n,[["__scopeId","data-v-9f827df5"]]),bn={class:"dialog-content"},kn={class:"sidebar-panel"},wn={key:0,class:"info-content"},$n={class:"message-content"},Cn={key:0,class:"message-text"},Sn={class:"env-list"},xn={class:"env-name"},En={class:"env-value"},Tn={class:"main-content"},Mn={class:"graph-header"},Nn={class:"graph-header-left"},Vn={class:"graph-controls"},zn={class:"graph-wrapper"},Bn={class:"drawer-header"},In={class:"drawer-header-left"},Ln={class:"drawer-icon-wrapper"},On={class:"drawer-title"},Dn={__name:"TaskDetailDialog",props:{modelValue:Boolean,taskName:String},emits:["update:modelValue"],setup(e,{emit:t}){const l=e,a=t,i=N(!1),k=N(!1),s=N(null),g=N([]),m=N([]),r=N(null);let d=null;X(()=>l.modelValue,async y=>{i.value=y,y&&l.taskName&&(await _(),C())}),X(i,y=>{a("update:modelValue",y),y||P()});const C=()=>{d&&(d.close(),d=null);const y=Ue(`${Y.task}/${l.taskName}/step`,{onMessage:p=>{p.data&&(g.value=p.data,_())}});d=y,y.connect()},_=async()=>{k.value=!0;try{const y=await Kt(l.taskName);s.value=y.data}catch(y){console.error("获取任务详情失败:",y)}finally{k.value=!1}},V=y=>{const p=m.value.find(E=>E.name===y);p?p.visible=!0:m.value.push({name:y,visible:!0})},T=y=>{const p=m.value.findIndex(E=>E.name===y);p>-1&&m.value.splice(p,1)},x=()=>{r.value&&r.value.fitView()},O=()=>{r.value&&r.value.zoomIn()},j=()=>{r.value&&r.value.zoomOut()},A=()=>{r.value&&r.value.actualSize()},P=()=>{d&&(d.close(),d=null),m.value=[],g.value=[],s.value=null};return ee(()=>{P()}),(y,p)=>{const E=We,F=te,ne=Re,w=Ie,u=ot,z=rt,I=mt,U=De;return b(),R(I,{modelValue:i.value,"onUpdate:modelValue":p[1]||(p[1]=W=>i.value=W),"close-on-click-modal":!1,"show-close":!1,onClose:P,fullscreen:"",class:"task-detail-dialog"},{header:c(()=>[o(h(ua),{icon:h(dt),title:e.taskName,onClose:p[0]||(p[0]=W=>i.value=!1)},null,8,["icon","title"])]),default:c(()=>{var W;return[ue((b(),$("div",bn,[n("div",kn,[o(E,{shadow:"hover",class:"info-card"},{header:c(()=>[o(h(Q),{icon:h(Ae),title:"任务信息"},null,8,["icon"])]),default:c(()=>[s.value?(b(),$("div",wn,[o(h(K),{label:"任务名称",value:s.value.name,hoverable:""},null,8,["value"]),o(h(K),{label:"任务类型",value:s.value.kind||"dag",hoverable:""},null,8,["value"]),o(h(K),{label:"任务状态",hoverable:""},{value:c(()=>[o(h(Fe),{status:s.value.state,effect:"light",size:"large","show-icon":""},null,8,["status"])]),_:1}),o(h(K),{label:"步骤数量",value:s.value.count,"value-class":"highlight",hoverable:""},null,8,["value"])])):D("",!0)]),_:1}),o(E,{shadow:"hover",class:"message-card"},{header:c(()=>[o(h(Q),{icon:h(nt),title:"执行信息"},null,8,["icon"])]),default:c(()=>{var B;return[n("div",$n,[(B=s.value)!=null&&B.message?(b(),$("p",Cn,S(s.value.message),1)):(b(),R(h(Ee),{key:1,description:"暂无执行信息",size:"small"}))])]}),_:1}),(W=s.value)!=null&&W.env&&s.value.env.length>0?(b(),R(E,{key:0,shadow:"hover",class:"env-card"},{header:c(()=>[o(h(Q),{icon:h(Pe),title:"环境变量",count:s.value.env.length},null,8,["icon","count"])]),default:c(()=>[o(ne,{"max-height":"280px"},{default:c(()=>[n("div",Sn,[(b(!0),$(re,null,ge(s.value.env,(B,G)=>(b(),$("div",{key:G,class:"env-item"},[n("div",xn,[o(F,{class:"env-icon"},{default:c(()=>[o(h(je))]),_:1}),n("span",null,S(B.name),1)]),n("div",En,S(B.value),1)]))),128))])]),_:1})]),_:1})):D("",!0)]),n("div",Tn,[o(E,{shadow:"hover",class:"graph-card"},{header:c(()=>[n("div",Mn,[n("div",Nn,[o(h(Q),{icon:h(Se),title:"DAG 流程图"},null,8,["icon"])]),n("div",Vn,[o(u,{size:"small"},{default:c(()=>[o(w,{onClick:x},{default:c(()=>[o(F,null,{default:c(()=>[o(h(st))]),_:1}),p[2]||(p[2]=oe(" 适应画布 ",-1))]),_:1}),o(w,{onClick:O},{default:c(()=>[o(F,null,{default:c(()=>[o(h(lt))]),_:1}),p[3]||(p[3]=oe(" 放大 ",-1))]),_:1}),o(w,{onClick:j},{default:c(()=>[o(F,null,{default:c(()=>[o(h(ct))]),_:1}),p[4]||(p[4]=oe(" 缩小 ",-1))]),_:1}),o(w,{onClick:A},{default:c(()=>[o(F,null,{default:c(()=>[o(h(it))]),_:1}),p[5]||(p[5]=oe(" 重置 ",-1))]),_:1})]),_:1})])])]),default:c(()=>[n("div",zn,[g.value.length>0?(b(),R(rn,{key:0,ref_key:"graphRef",ref:r,steps:g.value,"task-name":e.taskName,"show-toolbar":!1,onNodeClick:V},null,8,["steps","task-name"])):(b(),R(h(Ee),{key:1,icon:h(Se),description:"暂无步骤数据"},null,8,["icon"]))])]),_:1})])])),[[U,k.value]]),(b(!0),$(re,null,ge(m.value,B=>(b(),R(z,{key:B.name,modelValue:B.visible,"onUpdate:modelValue":G=>B.visible=G,direction:"rtl",size:"600px",onClose:G=>T(B.name),class:"step-drawer"},{header:c(()=>[n("div",Bn,[n("div",In,[n("div",Ln,[o(F,null,{default:c(()=>[o(h(ut))]),_:1})]),n("h3",On,S(B.name),1)]),o(w,{type:"danger",icon:h(Be),circle:"",size:"small",onClick:G=>T(B.name)},null,8,["icon","onClick"])])]),default:c(()=>[o(yn,{"task-name":e.taskName,"step-name":B.name},null,8,["task-name","step-name"])]),_:2},1032,["modelValue","onUpdate:modelValue","onClose"]))),128))]}),_:1},8,["modelValue"])}}},Qn=ae(Dn,[["__scopeId","data-v-0ea240ef"]]);export{Xn as C,ua as D,Jn as M,Yn as S,Qn as T,Kn as a,Hn as b,qn as c,Gn as d,Ht as e,Zn as f,ce as r,Un as t,Ue as u};
